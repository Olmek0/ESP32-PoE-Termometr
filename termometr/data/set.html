<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Ustawienia</title>
  <style>
    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      max-width: 1200px;
      background-color: var(--secbg);
      color: var(--wh1); 
      text-align: center; 
      padding: 15px 0;
      border-top: 1px solid var(--wh2);
    }
    footer a { font-weight: bold; }
    footer a:hover { text-decoration: underline; }
    .form-group { margin-bottom: 10px; }
    .btn { margin-top: 10px; }
    #status, #alertStatus { margin-top: 10px; }
  </style>
  <link rel="stylesheet" type="text/css" href="styl.css">
</head>
<body>
<div class="Page">
  <div class="container">
    <div class='Title'>
      <div id='TitleText'>Ustawienia</div>
    </div>
    <div class="form-group">
      <label><input type="radio" name="ipmode" id="dhcp" value="dhcp"> DHCP</label>
      <label><input type="radio" name="ipmode" id="static" value="static"> Static IP</label>
    </div>

    <div id="static-fields" style="display: none;">
      <div class="form-group"><label for="ip">Adres IP </label><input type="text" id="ip" placeholder="192.168.1.100"></div>
      <div class="form-group"><label for="gateway">Brama </label><input type="text" id="gateway" placeholder="192.168.1.1"></div>
      <div class="form-group"><label for="subnet">Maska podsieci </label><input type="text" id="subnet" placeholder="255.255.255.0"></div>
      <div class="form-group"><label for="dns1">Serwer DNS 1 </label><input type="text" id="dns1" placeholder="8.8.8.8"></div>
      <div class="form-group"><label for="dns2">Serwer DNS 2 </label><input type="text" id="dns2" placeholder="8.8.4.4"></div>
    </div>

    <button id="save-btn" class="btn">Zapisz</button>
    <div id="status"><br></div>

    <div class="section-title"><br>Konfiguracja alertów</div>
    <div class="form-group"><label for="highLimit"><br>Górny limit temperatury(°C) </label><input type="number" id="highLimit" step="0.1"></div>
    <div class="form-group"><label for="lowLimit">Dolny limit temperatury (°C) </label><input type="number" id="lowLimit" step="0.1"></div>
    <div class="form-group"><label for="recipientPhone">Numer telefonu </label><input type="email" id="recipientPhone"></div>
	<div class="form-group">
	<label for="apiKey">Klucz APIKEY </label>
	<input type="text" id="apiKey">	
	</div>
    <div class="form-group"><label><input type="checkbox" id="alertsEnabled"> Włącz alerty</label></div>
    <button id="save-alerts-btn" class="btn">Zapisz</button>
    <div id="alertStatus"></div>

  </div>

  <footer>
    <a href="/">← Powrót</a>
  </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- Network config ---
  fetch('/api/ipconfig')
    .then(res => res.json())
    .then(data => {
      document.getElementById('dhcp').checked = data.dhcp;
      document.getElementById('static').checked = !data.dhcp;
      document.getElementById('static-fields').style.display = data.dhcp ? 'none' : 'block';
      if (!data.dhcp) {
        document.getElementById('ip').value = data.ip;
        document.getElementById('gateway').value = data.gateway;
        document.getElementById('subnet').value = data.subnet;
        document.getElementById('dns1').value = data.dns1;
        document.getElementById('dns2').value = data.dns2 || '';
      }
    });

  document.querySelectorAll('input[name="ipmode"]').forEach(radio => {
    radio.addEventListener('change', function() {
      document.getElementById('static-fields').style.display = this.value === 'static' ? 'block' : 'none';
    });
  });

  document.getElementById('save-btn').addEventListener('click', async function() {
    const isDhcp = document.getElementById('dhcp').checked;
    const config = { dhcp: isDhcp };
    if (!isDhcp) {
      config.ip = document.getElementById('ip').value;
      config.gateway = document.getElementById('gateway').value;
      config.subnet = document.getElementById('subnet').value;
      config.dns1 = document.getElementById('dns1').value;
      config.dns2 = document.getElementById('dns2').value;
    }

    try {
      showStatus('status', 'Zapisywanie konfiguracji...', 'info');
      await fetch('/api/ipconfig', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config),
      });
      showStatus('status', 'Zapisano konfigurację. Oczekiwanie na nowe IP...', 'info');
      window.location.reload();
    } catch (err) {
      showStatus('status', 'Błąd w zapisie konfiguracji', 'error');
      console.error(err);
    }
  });
// --- Alert config ---
fetch('/api/alertconfig')
  .then(res => res.json())
  .then(data => {
    document.getElementById('highLimit').value = data.high;
    document.getElementById('lowLimit').value = data.low;
    document.getElementById('recipientEmail').value = data.email;
    document.getElementById('alertsEnabled').checked = data.alertsEnabled;
  });

document.getElementById('save-alerts-btn').addEventListener('click', async function() {
  const alertConfig = {
    high: parseFloat(document.getElementById('highLimit').value),
    low: parseFloat(document.getElementById('lowLimit').value),
    email: document.getElementById('recipientEmail').value,
    alertsEnabled: document.getElementById('alertsEnabled').checked
  };

  try {
    showStatus('alertStatus', 'Zapisywanie ustawień alertów...', 'info');
    await fetch('/api/alertconfig', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(alertConfig),
    });
    showStatus('alertStatus', 'Zapisano ustawienia alertów', 'success');
  } catch (err) {
    showStatus('alertStatus', 'Błąd w zapisywaniu ustawień alertów', 'error');
    console.error(err);                                                                                                          
  }
});
fetch('/api/alertconfig')
  .then(res => res.json())
  .then(data => {
    document.getElementById('highLimit').value = data.high;
    document.getElementById('lowLimit').value = data.low;
    document.getElementById('recipientPhone').value = data.phone;
    document.getElementById('apiKey').value = data.apikey;
    document.getElementById('alertsEnabled').checked = data.alertsEnabled;
  });

// Save alert config
document.getElementById('save-alerts-btn').addEventListener('click', async function() {
  const alertConfig = {
    high: parseFloat(document.getElementById('highLimit').value),
    low: parseFloat(document.getElementById('lowLimit').value),
    phone: document.getElementById('recipientPhone').value,
    apikey: document.getElementById('apiKey').value,
    alertsEnabled: document.getElementById('alertsEnabled').checked
  };

  if (isNaN(alertConfig.high) || isNaN(alertConfig.low) || (alertConfig.high < alertConfig.low)) {
    showStatus('alertStatus', 'Proszę podać właściwe temperatury', 'error');
    return;
  }
  if (alertConfig.alertsEnabled && (!alertConfig.phone || !alertConfig.apikey)) {
    showStatus('alertStatus', 'Proszę podać numer telefonu i klucz APIKEY', 'error');
    return;
  }

  try {
    showStatus('alertStatus', 'Zapisywanie ustawień...', 'info');
    const response = await fetch('/api/alertconfig', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(alertConfig)
    });
    
    if (response.ok) {
      showStatus('alertStatus', 'Zapisano ustawienia', 'success');
      
      if (alertConfig.alertsEnabled) {
        showStatus('alertStatus', 'Wysyłanie testowego alertu...', 'info');
        const testResponse = await fetch('/api/testalert', { method: 'POST' });
        if (testResponse.ok) {
          showStatus('alertStatus', 'Ustawienia zapisane i alert został wysłany', 'success');
        } else {
          showStatus('alertStatus', 'Ustawienia zapisane, ale nie udało się wysłać alertu', 'warning');
        }
      }
    } else {
      throw new Error('Server error');
    }
  } catch (err) {
    showStatus('alertStatus', 'Błąd w zapisywaniu ustawień alertów', 'error');
    console.error(err);
  }
});


  function showStatus(id, msg, type) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.className = type;
  }
});
</script>
</body>
</html>
